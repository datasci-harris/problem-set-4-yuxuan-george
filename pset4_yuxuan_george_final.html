<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yuxuan Geng &amp; George Wang">

<title>PS4</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="pset4_yuxuan_george_final_files/libs/clipboard/clipboard.min.js"></script>
<script src="pset4_yuxuan_george_final_files/libs/quarto-html/quarto.js"></script>
<script src="pset4_yuxuan_george_final_files/libs/quarto-html/popper.min.js"></script>
<script src="pset4_yuxuan_george_final_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="pset4_yuxuan_george_final_files/libs/quarto-html/anchor.min.js"></script>
<link href="pset4_yuxuan_george_final_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="pset4_yuxuan_george_final_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="pset4_yuxuan_george_final_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="pset4_yuxuan_george_final_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="pset4_yuxuan_george_final_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">PS4</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Yuxuan Geng &amp; George Wang </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p><strong>PS4:</strong> Due Sat Nov 2 at 5:00PM Central. Worth 100 points.</p>
<section id="style-points-10-pts" class="level2">
<h2 class="anchored" data-anchor-id="style-points-10-pts">Style Points (10 pts)</h2>
</section>
<section id="submission-steps-10-pts" class="level2">
<h2 class="anchored" data-anchor-id="submission-steps-10-pts">Submission Steps (10 pts)</h2>
<p>• Partner 1 (name and cnet ID): Georeg Wang, gwang613 • Partner 2 (name and cnet ID): Yuxuan Geng, yuxuan1123</p>
<p>This submission is our work alone and complies with the 30538 integrity policy. <strong><em>GW</em></strong> <strong><em>YG</em></strong></p>
<p>I have uploaded the names of anyone else other than my partner and I worked with on the problem set here.</p>
<p>Late coins used this pset: <strong><em>1</em></strong> Late coins left after submission: <strong><em>3</em></strong></p>
</section>
<section id="download-and-explore-the-provider-of-services-pos-file-10-pts" class="level2">
<h2 class="anchored" data-anchor-id="download-and-explore-the-provider-of-services-pos-file-10-pts">Download and explore the Provider of Services (POS) file (10 pts)</h2>
<ol type="1">
<li><p>The necessary variables are PRVDR_NUM, FAC_NAME, ZIP_CD, STATE_CD, PRVDR_CTGRY_CD, PRVDR_CTGRY_SBTYP_CD, PGM_TRMNTN_CD, TRMNTN_EXPRTN_DT, and CBSA_URBN_RRL_IND.</p></li>
<li><ol type="a">
<li></li>
</ol></li>
</ol>
<div id="02244292" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>alt.renderers.enable(<span class="st">"png"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the 2016 POS data</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>pos_2016 <span class="op">=</span> pd.read_csv(<span class="st">'POS_File_Hospital_Non_Hospital_Facilities_Q4_2016.csv'</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for short-term hospitals</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>short_term_hospitals <span class="op">=</span> pos_2016[</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  (pos_2016[<span class="st">'PRVDR_CTGRY_CD'</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  (pos_2016[<span class="st">'PRVDR_CTGRY_SBTYP_CD'</span>] <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number </span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>hospital_count <span class="op">=</span> short_term_hospitals.shape[<span class="dv">0</span>]</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>hospital_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>7245</code></pre>
</div>
</div>
<pre><code>b.</code></pre>
<p>It does make sense because two datasets (AHA and CMS) might have different methodoligies and classifications. We used data from the American Hospital Association (AHA) for FY2016: https://www.aha.org/system/files/2018-01/Fast%20Facts%202018%20pie%20charts.pdf. The AHA data may exclude certain hospitals that are included in the CMS POS dataset, such as smaller facilities. In addition, the AHA chart is based on FY2016 data published in 2018, while the CMS POS file might have had updates during the same period.</p>
<ol start="3" type="1">
<li></li>
</ol>
<div id="a8ec0515" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load POS data from 2017 to 2019</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>pos_2016[<span class="st">'Year'</span>] <span class="op">=</span> <span class="dv">2016</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>pos_2017 <span class="op">=</span> pd.read_csv(<span class="st">'POS_File_Hospital_Non_Hospital_Facilities_Q4_2017.csv'</span>, encoding<span class="op">=</span><span class="st">'ISO-8859-1'</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>pos_2017[<span class="st">'Year'</span>] <span class="op">=</span> <span class="dv">2017</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>pos_2018 <span class="op">=</span> pd.read_csv(<span class="st">'POS_File_Hospital_Non_Hospital_Facilities_Q4_2018.csv'</span>, encoding<span class="op">=</span><span class="st">'ISO-8859-1'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>pos_2018[<span class="st">'Year'</span>] <span class="op">=</span> <span class="dv">2018</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>pos_2019 <span class="op">=</span> pd.read_csv(<span class="st">'POS_File_Hospital_Non_Hospital_Facilities_Q4_2019.csv'</span>, encoding<span class="op">=</span><span class="st">'ISO-8859-1'</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>pos_2019[<span class="st">'Year'</span>] <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Appendix them</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>pos_all_years <span class="op">=</span> pd.concat([pos_2016, pos_2017, pos_2018, pos_2019], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot them using altair</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of observations per year</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>yearly_counts <span class="op">=</span> pos_all_years[<span class="st">'Year'</span>].value_counts().reset_index()</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>yearly_counts.columns <span class="op">=</span> [<span class="st">'Year'</span>, <span class="st">'Observations'</span>]</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>yearly_counts <span class="op">=</span> yearly_counts.sort_values(by<span class="op">=</span><span class="st">'Year'</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using Altair</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>chart <span class="op">=</span> alt.Chart(yearly_counts).mark_bar().encode(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'Year:O'</span>, title<span class="op">=</span><span class="st">'Year'</span>),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>alt.Y(<span class="st">'Observations:Q'</span>, title<span class="op">=</span><span class="st">'Number of Observations'</span>),</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">'Year'</span>, <span class="st">'Observations'</span>]</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Number of Observations by Year'</span>,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">200</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>chart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div>
<figure class="figure">
<p><img src="pset4_yuxuan_george_final_files/figure-html/cell-3-output-1.png" width="270" height="272" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<ol start="4" type="1">
<li><ol type="a">
<li></li>
</ol></li>
</ol>
<div id="f8e0ebff" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate unique hospitals per year</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>unique_hospitals_per_year <span class="op">=</span> pos_all_years.groupby(<span class="st">'Year'</span>)[<span class="st">'PRVDR_NUM'</span>].nunique().reset_index()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>unique_hospitals_per_year.columns <span class="op">=</span> [<span class="st">'Year'</span>, <span class="st">'Unique Hospitals'</span>]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the Altair chart </span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>unique_hospital_chart <span class="op">=</span> alt.Chart(unique_hospitals_per_year).mark_bar().encode(</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'Year:O'</span>, title<span class="op">=</span><span class="st">'Year'</span>),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>alt.Y(<span class="st">'Unique Hospitals:Q'</span>, title<span class="op">=</span><span class="st">'Number of Unique Hospitals'</span>),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">'Year'</span>, <span class="st">'Unique Hospitals'</span>]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>).properties(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Number of Unique Hospitals by Year'</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">200</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>unique_hospital_chart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>
<figure class="figure">
<p><img src="pset4_yuxuan_george_final_files/figure-html/cell-4-output-1.png" width="282" height="272" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<pre><code>b.</code></pre>
<p>Two plots are eseentially the same, showing that each row in the dataset likely corresponds to a unique hospital entry each year, even it is closed. It can be useful for analyzing hospital trends over time as no repeated hospital records within each year.</p>
</section>
<section id="identify-hospital-closures-in-pos-file-15-pts" class="level2">
<h2 class="anchored" data-anchor-id="identify-hospital-closures-in-pos-file-15-pts">Identify hospital closures in POS file (15 pts) (*)</h2>
<ol type="1">
<li></li>
</ol>
<div id="678f6eab" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter active hospitals in 2016</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>active_2016 <span class="op">=</span> pos_2016[pos_2016[<span class="st">'PGM_TRMNTN_CD'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a list to collect suspected closures</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>closures <span class="op">=</span> []</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check each year suspected closures</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> year <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2017</span>, <span class="dv">2020</span>):</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the hospital exists and is active in the next year, merging based on PRVDR_NUM</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    active_2016 <span class="op">=</span> active_2016.merge(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        pos_all_years[pos_all_years[<span class="st">'Year'</span>] <span class="op">==</span> year][[<span class="st">'PRVDR_NUM'</span>, <span class="st">'PGM_TRMNTN_CD'</span>]],</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">'PRVDR_NUM'</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        suffixes<span class="op">=</span>(<span class="st">''</span>, <span class="ss">f'_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    ).reset_index(drop<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify hospitals that are no longer active</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    suspected_closures <span class="op">=</span> active_2016[</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        (active_2016[<span class="ss">f'PGM_TRMNTN_CD_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">'</span>] <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store those suspected closures</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    suspected_closures[<span class="st">'CLS_YR'</span>] <span class="op">=</span> year</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    closures.append(suspected_closures[[<span class="st">'PRVDR_NUM'</span>, <span class="st">'FAC_NAME'</span>, <span class="st">'ZIP_CD'</span>, <span class="st">'CLS_YR'</span>]].reset_index(drop<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all suspected closures and remove duplicates </span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>closures_df <span class="op">=</span> pd.concat(closures).drop_duplicates(subset<span class="op">=</span><span class="st">'PRVDR_NUM'</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of unique suspected closures</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>num_suspected_closures <span class="op">=</span> closures_df.shape[<span class="dv">0</span>]</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Display</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>num_suspected_closures</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/k2/prgbv7z97knbd104r93pncfc0000gp/T/ipykernel_62738/474959087.py:23: SettingWithCopyWarning:


A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy

/var/folders/k2/prgbv7z97knbd104r93pncfc0000gp/T/ipykernel_62738/474959087.py:23: SettingWithCopyWarning:


A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy

/var/folders/k2/prgbv7z97knbd104r93pncfc0000gp/T/ipykernel_62738/474959087.py:23: SettingWithCopyWarning:


A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>5492</code></pre>
</div>
</div>
<ol start="2" type="1">
<li></li>
</ol>
<div id="3cc20c1d" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by FAC_NAME</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>sorted_closures_df <span class="op">=</span> closures_df.sort_values(by<span class="op">=</span><span class="st">'FAC_NAME'</span>).head(<span class="dv">10</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>sorted_closures_df[[<span class="st">'FAC_NAME'</span>, <span class="st">'CLS_YR'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">FAC_NAME</th>
<th data-quarto-table-cell-role="th">CLS_YR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4076</td>
<td>(CLOSED) REFLECTIONS TREATMENT AGENCY</td>
<td>2019</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5132</td>
<td>1ST CHOICE HEALTHCARE SERVICES INC</td>
<td>2019</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1782</td>
<td>1ST CHOICE HOME HEALTH</td>
<td>2017</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">952</td>
<td>1ST FAMILY HOME HEALTHCARE, INC</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">656</td>
<td>1ST HOME HEALTH CARE INC</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1249</td>
<td>21ST CENTURY HOME HEALTH AGENCY</td>
<td>2017</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2390</td>
<td>247 HOME HEALTH CARE</td>
<td>2019</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">937</td>
<td>24SEVEN HEALTH CARE SERVICES, INC</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1430</td>
<td>25 EAST SAME DAY SURGERY CENTE</td>
<td>2019</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1372</td>
<td>3 ANGELS HOME HEALTH</td>
<td>2019</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<ol start="3" type="1">
<li></li>
</ol>
<div id="f795f52c" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to count active hospitals by ZIP code </span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_active_hospitals_by_zip(data, year):</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    active_hospitals <span class="op">=</span> data[data[<span class="st">'PGM_TRMNTN_CD'</span>] <span class="op">==</span> <span class="dv">00</span>]  <span class="co"># Assuming "01" indicates active</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> active_hospitals.groupby(<span class="st">'ZIP_CD'</span>).size().rename(<span class="ss">f'active_hospitals_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get active hospital counts by ZIP code</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>count_2016 <span class="op">=</span> count_active_hospitals_by_zip(pos_2016, <span class="dv">2016</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>count_2017 <span class="op">=</span> count_active_hospitals_by_zip(pos_2017, <span class="dv">2017</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>count_2018 <span class="op">=</span> count_active_hospitals_by_zip(pos_2018, <span class="dv">2018</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>count_2019 <span class="op">=</span> count_active_hospitals_by_zip(pos_2019, <span class="dv">2019</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge counts into a single DataFrame</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>active_counts <span class="op">=</span> pd.DataFrame({</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2016'</span>: count_2016,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2017'</span>: count_2017,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2018'</span>: count_2018,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2019'</span>: count_2019</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>}).fillna(<span class="dv">0</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify suspected mergers/acquisitions following guidence</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>merger_acquisitions <span class="op">=</span> []</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>confirmed_closures <span class="op">=</span> []</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> closures_df.iterrows():</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    zip_code <span class="op">=</span> row[<span class="st">'ZIP_CD'</span>]</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    closure_year <span class="op">=</span> row[<span class="st">'CLS_YR'</span>]</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> closure_year <span class="op">&lt;</span> <span class="dv">2019</span>:</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        next_year <span class="op">=</span> closure_year <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> active_counts.loc[zip_code, <span class="bu">str</span>(next_year)] <span class="op">&gt;=</span> active_counts.loc[zip_code, <span class="bu">str</span>(closure_year)]:</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If the number does not decrease, it's likely a merger/acquisition</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>            merger_acquisitions.append(row)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If the number decreases, confirm it as a closure</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>            confirmed_closures.append(row)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert lists to DataFrames</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>merger_acquisitions_df <span class="op">=</span> pd.DataFrame(merger_acquisitions)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>confirmed_closures_df <span class="op">=</span> pd.DataFrame(confirmed_closures)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop duplicate if they have the same facility name and ZIP code</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>merger_acquisitions_df <span class="op">=</span> merger_acquisitions_df.drop_duplicates(subset<span class="op">=</span>[<span class="st">'FAC_NAME'</span>, <span class="st">'ZIP_CD'</span>])</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Count and display</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>num_merger_acquisitions <span class="op">=</span> merger_acquisitions_df.shape[<span class="dv">0</span>]</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of Hospitals Potentially Closed due to Merger/Acquisition:"</span>, num_merger_acquisitions)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Potential Mergers/Acquisitions:</span><span class="ch">\n</span><span class="st">"</span>, merger_acquisitions_df[[<span class="st">'FAC_NAME'</span>, <span class="st">'ZIP_CD'</span>, <span class="st">'CLS_YR'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of Hospitals Potentially Closed due to Merger/Acquisition: 2961
Potential Mergers/Acquisitions:
                                FAC_NAME   ZIP_CD  CLS_YR
0              GADSDEN REGIONAL HOSPICE  35901.0    2017
1               SOUTHERNCARE MONTGOMERY  36117.0    2017
2                  SOUTHERNCARE GADSDEN  35901.0    2017
3               SOUTHERNCARE GROVE HILL  36451.0    2017
4                SOUTHERNCARE DEMOPOLIS  36732.0    2017
...                                 ...      ...     ...
3735           SAINT DAVID HOSPICE, INC  91602.0    2018
3736                    SENIORS HOSPICE  91402.0    2018
3738  UNITED ALLIANCE HOSPICE CARE, INC  91506.0    2018
3739                 A &amp; A HOSPICE, INC  91401.0    2018
3740       CHARTWELL HOSPICE CARE, INC.  90241.0    2018

[2961 rows x 3 columns]</code></pre>
</div>
</div>
<pre><code>b.</code></pre>
<div id="de649684" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop duplicate entries from confirmed closures if they have the same facility name and ZIP code</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>confirmed_closures_df <span class="op">=</span> confirmed_closures_df.drop_duplicates(subset<span class="op">=</span>[<span class="st">'FAC_NAME'</span>, <span class="st">'ZIP_CD'</span>])</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Count and display the number of confirmed closures after removing mergers/acquisitions</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>num_confirmed_closures <span class="op">=</span> confirmed_closures_df.shape[<span class="dv">0</span>]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of Confirmed Closures after Removing Potential Mergers/Acquisitions:"</span>, num_confirmed_closures)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Confirmed Closures:</span><span class="ch">\n</span><span class="st">"</span>, confirmed_closures_df[[<span class="st">'FAC_NAME'</span>, <span class="st">'ZIP_CD'</span>, <span class="st">'CLS_YR'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of Confirmed Closures after Removing Potential Mergers/Acquisitions: 764
Confirmed Closures:
                                            FAC_NAME   ZIP_CD  CLS_YR
6                               SOUTHERNCARE DOTHAN  36303.0    2017
15                          VALLEY HEAD CLINIC, LLC  35967.0    2017
18                              CHEAHA MH/MR CENTER  35160.0    2017
32                                  GENTIVA HOSPICE  85711.0    2017
34                    GRACE HOSPICE OF ARIZONA, INC  85282.0    2017
...                                             ...      ...     ...
3661                    TEXAS SENIOR HOMEHEALTH INC  75252.0    2018
3683  MIRACLE HANDS HEALTHCARE SERVICES CORPORATION  77489.0    2018
3691                  HEFTY HEALTHCARE SERVICES INC  77074.0    2018
3693             ASSURANCE HEALTH CARE SERVICES INC  77071.0    2018
3710                           AVID HOME HEALTH INC  78754.0    2018

[764 rows x 3 columns]</code></pre>
</div>
</div>
<pre><code>c.</code></pre>
<div id="aae91b28" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by facility name and show head</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>sorted_confirmed_closures <span class="op">=</span> confirmed_closures_df.sort_values(by<span class="op">=</span><span class="st">'FAC_NAME'</span>).head(<span class="dv">10</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sorted_confirmed_closures[[<span class="st">'FAC_NAME'</span>, <span class="st">'ZIP_CD'</span>, <span class="st">'CLS_YR'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                    FAC_NAME   ZIP_CD  CLS_YR
656                 1ST HOME HEALTH CARE INC  33155.0    2018
937        24SEVEN HEALTH CARE SERVICES, INC  60659.0    2018
1537                      5 STAR HOSPICE LLC  84097.0    2017
3515     A &amp; T MULTI-HEALTHCARE SERVICES LLC  77036.0    2018
2212                            A C L D, INC  11747.0    2018
1705           A&amp;A RELIABLE HOME HEALTH CARE  55104.0    2018
1886  A-1 ADVANTAGE HOME HEALTH SERVICES INC  77027.0    2017
1856             AAA HEALTHCARE SERVICES INC  77036.0    2017
1202                 ABBLE HOME SERVICES LLC  43081.0    2017
1491                 ABICARE HOME HEALTH LLC  75234.0    2017</code></pre>
</div>
</div>
</section>
<section id="download-census-zip-code-shapefile-10-pt" class="level2">
<h2 class="anchored" data-anchor-id="download-census-zip-code-shapefile-10-pt">Download Census zip code shapefile (10 pt)</h2>
<ol type="1">
<li><ol type="a">
<li><p>The .shp file has the shapes (geometry) of the features, such as points. The .shx file is an index that links these shapes to data stored in the .dbf file. The .dbf file has attribute data in a table format, with each row representing to a shape in .shp file. The .prj file has information of the map projection and coordinate system to display a map correctly. The .xml file has metadata, like the dataset’s source and description.</p></li>
<li><p>dbf: 6.4 MB prj: 165 bytes shp: 837.5 MB shx: 265 KB xml: 16 KB</p></li>
</ol></li>
</ol>
<p>The .shp and .dbf files are the largest because they contain the main geometric and attribute data, respectively. The .prj, .shx, and .xml files are usually smaller.</p>
<ol start="2" type="1">
<li></li>
</ol>
<div id="7f4e65af" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the shapefile for ZIP code boundaries</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>shapefile_path <span class="op">=</span> <span class="st">'/Users/georgew/Desktop/Fall 2024/PPHA 30538/problem-set-4-yuxuan-george/gz_2010_us_860_00_500k/gz_2010_us_860_00_500k.shp'</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>zip_codes <span class="op">=</span> gpd.read_file(shapefile_path)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean and convert ZIP codes in `zip_codes` to strings</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>zip_codes[<span class="st">'ZCTA5'</span>] <span class="op">=</span> zip_codes[<span class="st">'ZCTA5'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="vs">r'\.0$'</span>, <span class="st">''</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter ZIP codes for Texas</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>texas_zip <span class="op">=</span> zip_codes[zip_codes[<span class="st">'ZCTA5'</span>].<span class="bu">str</span>.startswith((<span class="st">'75'</span>, <span class="st">'76'</span>, <span class="st">'77'</span>, <span class="st">'78'</span>, <span class="st">'79'</span>))]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter hospital data for Texas ZIP codes starting with specific prefixes</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>texas_hospital <span class="op">=</span> pos_2016[(pos_2016[<span class="st">'STATE_CD'</span>] <span class="op">==</span> <span class="st">'TX'</span>) <span class="op">&amp;</span> </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                          (pos_2016[<span class="st">'ZIP_CD'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="vs">r'\.0$'</span>, <span class="st">''</span>, regex<span class="op">=</span><span class="va">True</span>).<span class="bu">str</span>.startswith((<span class="st">'75'</span>, <span class="st">'76'</span>, <span class="st">'77'</span>, <span class="st">'78'</span>, <span class="st">'79'</span>)))]</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Count hospitals per ZIP code</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>texas_hospital_num <span class="op">=</span> texas_hospital.groupby(<span class="st">'ZIP_CD'</span>).size().reset_index(name<span class="op">=</span><span class="st">'hospital_count'</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert both ZIP code columns to string for merging</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>texas_hospital_num[<span class="st">'ZIP_CD'</span>] <span class="op">=</span> texas_hospital_num[<span class="st">'ZIP_CD'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="vs">r'\.0$'</span>, <span class="st">''</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge ZIP code boundaries with hospital counts</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>texas_hospital_merged <span class="op">=</span> texas_zip.merge(texas_hospital_num, left_on<span class="op">=</span><span class="st">'ZCTA5'</span>, right_on<span class="op">=</span><span class="st">'ZIP_CD'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill NaN values in 'hospital_count' with 0</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>texas_hospital_merged[<span class="st">'hospital_count'</span>] <span class="op">=</span> texas_hospital_merged[<span class="st">'hospital_count'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Print hospital count per zip, and describe the describe</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(texas_hospital_merged[[<span class="st">'ZCTA5'</span>, <span class="st">'hospital_count'</span>]].head())</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(texas_hospital_merged[<span class="st">'hospital_count'</span>].describe())</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the number of hospitals per ZIP code in Texas (color was adjusted to make hot spots more obvious)</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>), dpi<span class="op">=</span><span class="dv">72</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>texas_hospital_merged.plot(</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'hospital_count'</span>,</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">'YlOrBr'</span>,</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">'0.6'</span>,</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    vmin<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    vmax<span class="op">=</span><span class="dv">60</span> <span class="co"># lower max to make maps more obvious</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Number of Hospitals per ZIP Code in Texas (2016) (Count)"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Show plot</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ZCTA5  hospital_count
0  78624            21.0
1  78626            25.0
2  78628            11.0
3  78631             0.0
4  78632             0.0
count    1935.000000
mean        8.119897
std        14.024321
min         0.000000
25%         0.000000
50%         2.000000
75%        11.000000
max       195.000000
Name: hospital_count, dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset4_yuxuan_george_final_files/figure-html/cell-10-output-2.png" width="435" height="467" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="calculate-zip-codes-distance-to-the-nearest-hospital-20-pts" class="level2">
<h2 class="anchored" data-anchor-id="calculate-zip-codes-distance-to-the-nearest-hospital-20-pts">Calculate zip code’s distance to the nearest hospital (20 pts) (*)</h2>
<ol type="1">
<li></li>
</ol>
<div id="82cb0021" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the shapefile for ZIP code boundaries</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>shapefile_path <span class="op">=</span> <span class="st">'/Users/georgew/Desktop/Fall 2024/PPHA 30538/problem-set-4-yuxuan-george/gz_2010_us_860_00_500k/gz_2010_us_860_00_500k.shp'</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>zip_codes <span class="op">=</span> gpd.read_file(shapefile_path)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the centroids of each ZIP code polygon and create a GeoDataFrame</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>zips_all_centroids <span class="op">=</span> zip_codes.copy()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>zips_all_centroids[<span class="st">'geometry'</span>] <span class="op">=</span> zip_codes.centroid</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Display dimensions and columns of the resulting GeoDataFrame</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>dimensions <span class="op">=</span> zips_all_centroids.shape</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> zips_all_centroids.columns</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Dimensions of the GeoDataFrame: </span><span class="sc">{</span>dimensions<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Columns: </span><span class="sc">{</span>columns<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/k2/prgbv7z97knbd104r93pncfc0000gp/T/ipykernel_62738/2933873005.py:7: UserWarning:

Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Dimensions of the GeoDataFrame: (33120, 6)
Columns: Index(['GEO_ID', 'ZCTA5', 'NAME', 'LSAD', 'CENSUSAREA', 'geometry'], dtype='object')</code></pre>
</div>
</div>
<p>The zips_all_centroids GeoDataFrame has 3,120 rows and 6 columns, representing ZIP code centroids across the U.S. The columns include GEO_ID (unique geographic identifier), ZCTA5 (5-digit ZIP code), NAME (ZIP code label), LSAD (type of geographic area), CENSUSAREA (area size), and geometry (centroid coordinates as point geometries). This data allows for analyzing or visualizing central points of ZIP code areas.</p>
<ol start="2" type="1">
<li></li>
</ol>
<div id="ef797b66" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the zips_all_centroids </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>shapefile_path <span class="op">=</span> <span class="st">'/Users/georgew/Desktop/Fall 2024/PPHA 30538/problem-set-4-yuxuan-george/gz_2010_us_860_00_500k/gz_2010_us_860_00_500k.shp'</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>zips_all_centroids <span class="op">=</span> gpd.read_file(shapefile_path)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate centroids</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>zips_all_centroids[<span class="st">'geometry'</span>] <span class="op">=</span> zips_all_centroids.centroid</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Texas ZIP code prefixes</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>texas_prefixes <span class="op">=</span> (<span class="st">'75'</span>, <span class="st">'76'</span>, <span class="st">'77'</span>, <span class="st">'78'</span>, <span class="st">'79'</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Bordering states ZIP code prefixes</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>border_states_prefixes <span class="op">=</span> texas_prefixes <span class="op">+</span> (<span class="st">'73'</span>, <span class="st">'74'</span>, <span class="st">'70'</span>, <span class="st">'71'</span>, <span class="st">'72'</span>, <span class="st">'86'</span>, <span class="st">'87'</span>, <span class="st">'88'</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create gdf for all ZIP codes in Texas</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>zips_texas_centroids <span class="op">=</span> zips_all_centroids[zips_all_centroids[<span class="st">'ZCTA5'</span>].<span class="bu">str</span>.startswith(texas_prefixes)]</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create gdf for all ZIP codes in Texas or bordering states</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>zips_texas_borderstates_centroids <span class="op">=</span> zips_all_centroids[zips_all_centroids[<span class="st">'ZCTA5'</span>].<span class="bu">str</span>.startswith(border_states_prefixes)]</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the number of unique ZIP codes in each subset</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>unique_texas_zip_codes <span class="op">=</span> zips_texas_centroids[<span class="st">'ZCTA5'</span>].nunique()</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>unique_borderstates_zip_codes <span class="op">=</span> zips_texas_borderstates_centroids[<span class="st">'ZCTA5'</span>].nunique()</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>unique_texas_zip_codes, unique_borderstates_zip_codes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/k2/prgbv7z97knbd104r93pncfc0000gp/T/ipykernel_62738/2562787517.py:6: UserWarning:

Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(1935, 4160)</code></pre>
</div>
</div>
<p>There are 1,935 unique ZIP codes in Texas and 4,160 unique ZIP codes in Texas or bordering states.</p>
<ol start="3" type="1">
<li></li>
</ol>
<div id="77325b5e" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the gdf containing Texas and bordering states ZIP code centroids</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>zips_with_hospital <span class="op">=</span> zips_texas_borderstates_centroids.merge(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    texas_hospital_num,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'ZCTA5'</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'ZIP_CD'</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to keep only ZIP codes with at least 1 hospital in 2016</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>zips_withhospital_centroids <span class="op">=</span> zips_with_hospital[zips_with_hospital[<span class="st">'hospital_count'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I used a left merge on the ZIP code variable (ZCTA5 from the ZIP code GeoDataFrame and ZIP_CD from the hospital dataset).</p>
<ol start="4" type="1">
<li><ol type="a">
<li></li>
</ol></li>
</ol>
<div id="d65cdaa3" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.ops <span class="im">import</span> nearest_points</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset to 10 ZIP codes from Texas</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>subset_texas_centroids <span class="op">=</span> zips_texas_centroids.sample(<span class="dv">10</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Start timer to measure time</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>nearest_distances <span class="op">=</span> []</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the distance to the nearest ZIP code with a hospital for each ZIP code</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> subset_texas_centroids.iterrows():</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    origin_point <span class="op">=</span> row[<span class="st">'geometry'</span>]</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    nearest_point <span class="op">=</span> nearest_points(origin_point, zips_withhospital_centroids.unary_union)[<span class="dv">1</span>]</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    distance <span class="op">=</span> origin_point.distance(nearest_point)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    nearest_distances.append(distance)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co"># End</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>end_time <span class="op">=</span> time.time()</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the elapsed time</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>elapsed_time <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Time taken for 10 ZIP codes: </span><span class="sc">{</span>elapsed_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate time for the entire dataset (linear scaling)</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>total_time_estimate <span class="op">=</span> (elapsed_time <span class="op">/</span> <span class="dv">10</span>) <span class="op">*</span> <span class="bu">len</span>(zips_texas_centroids)</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Estimated time for entire dataset: </span><span class="sc">{</span>total_time_estimate <span class="op">/</span> <span class="dv">60</span><span class="sc">:.2f}</span><span class="ss"> minutes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time taken for 10 ZIP codes: 0.01 seconds
Estimated time for entire dataset: 0.02 minutes</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/k2/prgbv7z97knbd104r93pncfc0000gp/T/ipykernel_62738/3423632555.py:17: DeprecationWarning:

The 'unary_union' attribute is deprecated, use the 'union_all()' method instead.
</code></pre>
</div>
</div>
<p>The following time change every time. Time taken for 10 ZIP codes: 0.01 seconds Estimated time for entire dataset: 0.02 minutes</p>
<pre><code>b.</code></pre>
<div id="b45c168f" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the timer to measure computation time</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the distance in the full dataset</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>nearest_distances <span class="op">=</span> []</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> zips_texas_centroids.iterrows():</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    origin_point <span class="op">=</span> row[<span class="st">'geometry'</span>]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    nearest_point <span class="op">=</span> nearest_points(origin_point, zips_withhospital_centroids.unary_union)[<span class="dv">1</span>]</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    distance <span class="op">=</span> origin_point.distance(nearest_point)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    nearest_distances.append(distance)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co"># End the timer</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>end_time <span class="op">=</span> time.time()</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the elapsed time</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>elapsed_time <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Time taken for full dataset: </span><span class="sc">{</span>elapsed_time <span class="op">/</span> <span class="dv">60</span><span class="sc">:.2f}</span><span class="ss"> minutes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/k2/prgbv7z97knbd104r93pncfc0000gp/T/ipykernel_62738/2796076469.py:8: DeprecationWarning:

The 'unary_union' attribute is deprecated, use the 'union_all()' method instead.
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Time taken for full dataset: 0.02 minutes</code></pre>
</div>
</div>
<pre><code>c.</code></pre>
<p>The CRS is GCS North American 1983 (NAD83). UNIT[“Degree”,0.017453292519943295]. The unit is in degrees.</p>
<div id="65b37cd7" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the nearest distances in degrees to the gdf</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>zips_texas_centroids <span class="op">=</span> zips_texas_centroids.copy()  <span class="co"># Avoid SettingWithCopyWarning</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>zips_texas_centroids[<span class="st">'nearest_hospital_distance_degrees'</span>] <span class="op">=</span> nearest_distances</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>zips_texas_centroids[<span class="st">'nearest_hospital_distance_miles'</span>] <span class="op">=</span> zips_texas_centroids[<span class="st">'nearest_hospital_distance_degrees'</span>] <span class="op">*</span> <span class="dv">69</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="5" type="1">
<li><ol type="a">
<li><p>Now, it is in miles.</p></li>
<li></li>
</ol></li>
</ol>
<div id="2a02328a" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average distance in miles</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>average_distance_miles <span class="op">=</span> zips_texas_centroids[<span class="st">'nearest_hospital_distance_miles'</span>].mean()</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average distance to the nearest hospital (in miles): </span><span class="sc">{</span>average_distance_miles<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average distance to the nearest hospital (in miles): 4.23</code></pre>
</div>
</div>
<p>Average distance to the nearest hospital (in miles): 4.23. This makes sense beucase many urban areas have hospitals in ver close distance that can balance out some far distance from hositals in rural areas. c.</p>
<div id="7d89bd29" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), dpi<span class="op">=</span><span class="dv">72</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>zips_texas_centroids.plot(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'nearest_hospital_distance_miles'</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">'0.6'</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Average Distance to Nearest Hospital for Each ZIP Code in Texas (in miles)"</span>)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset4_yuxuan_george_final_files/figure-html/cell-18-output-1.png" width="555" height="574" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="effects-of-closures-on-access-in-texas-15-pts" class="level2">
<h2 class="anchored" data-anchor-id="effects-of-closures-on-access-in-texas-15-pts">Effects of closures on access in Texas (15 pts)</h2>
<ol type="1">
<li></li>
</ol>
<div id="369e3212" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to strings</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>confirmed_closures_df[<span class="st">'ZIP_CD'</span>] <span class="op">=</span> confirmed_closures_df[<span class="st">'ZIP_CD'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the closures</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>closures_texas <span class="op">=</span> confirmed_closures_df[</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    (confirmed_closures_df[<span class="st">'ZIP_CD'</span>].<span class="bu">str</span>.startswith((<span class="st">'75'</span>, <span class="st">'76'</span>, <span class="st">'77'</span>, <span class="st">'78'</span>, <span class="st">'79'</span>)))</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by ZIP code and count closrues</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>closures_by_zip <span class="op">=</span> closures_texas.groupby(<span class="st">'ZIP_CD'</span>).size().reset_index(name<span class="op">=</span><span class="st">'Number_of_Closures'</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the table of the number of closures by ZIP code</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>closures_by_zip.sort_values(by<span class="op">=</span><span class="st">'Number_of_Closures'</span>, ascending<span class="op">=</span><span class="va">False</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(closures_by_zip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     ZIP_CD  Number_of_Closures
43  77036.0                  30
56  77477.0                  14
49  77074.0                  11
46  77063.0                   5
7   75150.0                   4
..      ...                 ...
41  77030.0                   1
1   75044.0                   1
45  77060.0                   1
48  77072.0                   1
85  79905.0                   1

[86 rows x 2 columns]</code></pre>
</div>
</div>
<ol start="2" type="1">
<li></li>
</ol>
<div id="2d553d0e" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>closures_by_zip[<span class="st">'ZIP_CD'</span>] <span class="op">=</span> closures_by_zip[<span class="st">'ZIP_CD'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="vs">r'\.0$'</span>, <span class="st">''</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Texas ZIP code boundaries </span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>closures_choropleth <span class="op">=</span> texas_zip.merge(closures_by_zip, left_on<span class="op">=</span><span class="st">'ZCTA5'</span>, right_on<span class="op">=</span><span class="st">'ZIP_CD'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill NaN values in 'Number_of_Closures' with 0</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>closures_choropleth[<span class="st">'Number_of_Closures'</span>] <span class="op">=</span> closures_choropleth[<span class="st">'Number_of_Closures'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the choropleth showing affected ZIP codes</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), dpi<span class="op">=</span><span class="dv">72</span>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>closures_choropleth.plot(</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'Number_of_Closures'</span>,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">'YlOrBr'</span>,</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">'0.6'</span>,</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    vmin <span class="op">=</span> <span class="dv">0</span>,</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    vmax <span class="op">=</span> <span class="dv">10</span> <span class="co"># lower max to make the map more obvious</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Number of Closures by ZIP Code in Texas (2016-2019)"</span>)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of directly affected ZIP codes</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>directly_affected_zip_codes <span class="op">=</span> closures_choropleth[closures_choropleth[<span class="st">'Number_of_Closures'</span>] <span class="op">&gt;</span> <span class="dv">0</span>].shape[<span class="dv">0</span>]</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of directly affected ZIP codes in Texas: </span><span class="sc">{</span>directly_affected_zip_codes<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset4_yuxuan_george_final_files/figure-html/cell-20-output-1.png" width="555" height="578" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of directly affected ZIP codes in Texas: 86</code></pre>
</div>
</div>
<ol start="3" type="1">
<li></li>
</ol>
<div id="a94870ca" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to get directly affected ZIP codes</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>directly_affected_gdf <span class="op">=</span> closures_choropleth[closures_choropleth[<span class="st">'Number_of_Closures'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject to a CRS</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> directly_affected_gdf.crs.is_geographic:</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    directly_affected_gdf <span class="op">=</span> directly_affected_gdf.to_crs(epsg<span class="op">=</span><span class="dv">3857</span>) </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 10-mile buffer around directly affected ZIP codes (approx. 16093.4 meters)</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>directly_affected_buffer <span class="op">=</span> directly_affected_gdf.copy()</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>directly_affected_buffer[<span class="st">'geometry'</span>] <span class="op">=</span> directly_affected_buffer.geometry.<span class="bu">buffer</span>(<span class="fl">16093.4</span>)  </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject back to original CRS for further operations</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> directly_affected_buffer.crs <span class="op">!=</span> texas_zip.crs:</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    directly_affected_buffer <span class="op">=</span> directly_affected_buffer.to_crs(texas_zip.crs)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform spatial join to find indirectly affected ZIP codes</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>indirectly_affected_gdf <span class="op">=</span> gpd.sjoin(texas_zip, directly_affected_buffer, how<span class="op">=</span><span class="st">'inner'</span>, predicate<span class="op">=</span><span class="st">'intersects'</span>)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove duplicates </span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'ZCTA5_left'</span> <span class="kw">in</span> indirectly_affected_gdf.columns:</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    indirectly_affected_gdf <span class="op">=</span> indirectly_affected_gdf.drop_duplicates(subset<span class="op">=</span><span class="st">'ZCTA5_left'</span>)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="st">'ZCTA5'</span> <span class="kw">in</span> indirectly_affected_gdf.columns:</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    indirectly_affected_gdf <span class="op">=</span> indirectly_affected_gdf.drop_duplicates(subset<span class="op">=</span><span class="st">'ZCTA5'</span>)</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Count</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>num_indirectly_affected <span class="op">=</span> indirectly_affected_gdf.shape[<span class="dv">0</span>]</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of indirectly affected ZIP codes: </span><span class="sc">{</span>num_indirectly_affected<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of indirectly affected ZIP codes: 896</code></pre>
</div>
</div>
<ol start="4" type="1">
<li></li>
</ol>
<div id="f745fad7" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> mpatches</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure texas_zip has a copy to avoid warnings</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>texas_zip <span class="op">=</span> texas_zip.copy()</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop any rows with missing geometries</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>texas_zip <span class="op">=</span> texas_zip[texas_zip[<span class="st">'geometry'</span>].notna()]</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure that CRS is consistent across gdf</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> texas_zip.crs <span class="op">!=</span> indirectly_affected_gdf.crs:</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    indirectly_affected_gdf <span class="op">=</span> indirectly_affected_gdf.to_crs(texas_zip.crs)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign categories to each ZIP code</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>texas_zip[<span class="st">'affected_category'</span>] <span class="op">=</span> <span class="st">'Not Affected'</span>  <span class="co"># Default to 'Not Affected'</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark directly affected ZIP codes</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>texas_zip.loc[texas_zip[<span class="st">'ZCTA5'</span>].isin(directly_affected_gdf[<span class="st">'ZCTA5'</span>]), <span class="st">'affected_category'</span>] <span class="op">=</span> <span class="st">'Directly Affected'</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark indirectly affected ZIP codes </span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>texas_zip.loc[</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    (texas_zip[<span class="st">'ZCTA5'</span>].isin(indirectly_affected_gdf[<span class="st">'ZCTA5_right'</span>])) <span class="op">&amp;</span> </span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    (texas_zip[<span class="st">'affected_category'</span>] <span class="op">!=</span> <span class="st">'Directly Affected'</span>),</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'affected_category'</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>] <span class="op">=</span> <span class="st">'Indirectly Affected'</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with missing geometries again</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>texas_zip <span class="op">=</span> texas_zip[texas_zip[<span class="st">'geometry'</span>].notna()]</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Create choropleth plot</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>), dpi<span class="op">=</span><span class="dv">72</span>)</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>category_colors <span class="op">=</span> {</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Not Affected'</span>: <span class="st">'#d3d3d3'</span>,  <span class="co"># Gray for not affected</span></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Directly Affected'</span>: <span class="st">'#ff0000'</span>,  <span class="co"># Red for directly affected</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Indirectly Affected'</span>: <span class="st">'#ffa500'</span>  <span class="co"># Orange for indirectly affected</span></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot each category separately</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> category, color <span class="kw">in</span> category_colors.items():</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> texas_zip[texas_zip[<span class="st">'affected_category'</span>] <span class="op">==</span> category]</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> subset.empty:</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>        subset.plot(</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>color,</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>category</span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Create custom legend </span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>legend_patches <span class="op">=</span> [</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>    mpatches.Patch(color<span class="op">=</span>color, label<span class="op">=</span>category)</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> category, color <span class="kw">in</span> category_colors.items()</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Add title and legend</span></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Texas ZIP Codes Categorized by Effect of Closures"</span>)</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>plt.legend(handles<span class="op">=</span>legend_patches, loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pset4_yuxuan_george_final_files/figure-html/cell-22-output-1.png" width="368" height="360" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="reflecting-on-the-exercise-10-pts" class="level2">
<h2 class="anchored" data-anchor-id="reflecting-on-the-exercise-10-pts">Reflecting on the exercise (10 pts)</h2>
<ol type="a">
<li>First, there can be delayed data reporting that hospitals might close, but the official count could remain the same due to reporting delays. This could miss closures if we only look at a year to year comparison. In this case, we could track closures over multiple years, including a broader time range to confirm hospital closures with less impact form delay data reporting.</li>
</ol>
<p>Second, when hospitals merge or are acquired, they may be recorded differently, causing a reduction in count. This can happen even when the facility remains operation after merger. One of the approaches we used is to identify areas where the total hospital count doesn’t decrease. To improve this, we could use text-matching algorithms to recognize mergers and acquisitions in the dataset (especially for hospitals with similar names), identifying cases where hospitals change ownership or merge but continue operations. We even can collect more information on the ownership strcuture or the adress to see whether mergers are represented clearly, which can better reflect hospital closures.</p>
<p>Third, we rely on zip code data alone. ZIP code-based hospital counts may not capture nuanced details, such as changes in hospital size or service capacity. To improve this problem, we could consider incorporating other indicators like bed counts to better reflect hospital closures.</p>
<ol start="2" type="a">
<li>The current method identifies affected ZIP codes by counting hospitals per ZIP code annually. We listed suspected closures by finding hospitals active in 2016 but inactive in later years, removing cases where hospital counts remained steady, suggesting mergers or acquisitions. This approach provides a straightforward way to detect closures and their immediate impact at the ZIP code level, but also has some limitations.</li>
</ol>
<p>First, ZIP codes represent administrative boundaries, which may not reflect well actual patient access. Hospitals just outside a ZIP code boundary may still be accessible to residents, but this wouldn’t be captured in the current method. To improve this, we could expand the analysis to include nearby ZIP codes or using a distance-based method like within a certain radius to reflect access more accurately, such as using google API to better reflect the distance as an indicator to accessibility.</p>
<p>Second, the current method doesn’t account for actual travel distances or times. This will misrepresents access in rural versus urban areas, where 10 miles can represent vastly different travel times. To improve this, we could use GIS tools to calculate driving distances or estimated travel times to the nearest hospital would provide a more coorect accessibility. This could be particularly valuable in areas where a single closure forces patients to travel farther.</p>
<p>Third, we ignore the hospital capacity and services. Not all hospitals have the same capacity or the same services, so the simple count of hospitals might not reflect actual healthcare availability, especially if closures affect larger hospitals or facilities offering specialized care. To improve this, we can include more data on services availability into the analysis to better reflect healthcare access changes with in zip codes.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>